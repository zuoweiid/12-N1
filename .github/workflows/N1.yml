name: Build N1 70+o and 70+               ## Actionså·¥ä½œæµçš„åç§°
on:
  repository_dispatch:
  workflow_dispatch:                ## å·¥ä½œæµç¨‹_è°ƒåº¦
    inputs:
      days:
        description: 'å¤©æ•°.' # Number of days
        required: true
        default: 60
      minimum_runs:
        description: 'æ¯ä¸ªå·¥ä½œæµç¨‹è¦ä¿ç•™çš„æœ€å°‘è¿è¡Œæ¬¡æ•°.'  # The minimum runs to keep for each workflow
        required: true
        default: 24
  schedule:
    - cron: 30 23 * * *            # æ¯æ—¥ä¸Šåˆ7:30è‡ªåŠ¨ç¼–è¯‘
env:
  UPLOAD_COWTRANSFER: true     # å˜é‡ å¥¶ç‰›ä¸Šä¼ 
  RELEASE: true                 # å˜é‡ GitHubå‘å¸ƒ
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-20.04            ## â†é€‰æ‹©ç¼–è¯‘ç³»ç»Ÿç‰ˆæœ¬
    name: Build for ${{ matrix.flippy_name }}              # å·¥ä½œæµçš„åç§°
    strategy:
      fail-fast: false
      matrix:
        include:              # åŒ…æ‹¬
          - flippy_name: 70+o            # å·¥ä½œæµçš„åç§°
            release_name: N1-wangxiaofeng-70+o.img        # å›ºä»¶çš„åç§°
          - flippy_name: 70+           # å·¥ä½œæµçš„åç§°
            release_name: N1-wangxiaofeng-70+.img         # å›ºä»¶çš„åç§°

    env:
      FLIPPY_NAME: ${{ matrix.flippy_name }}               # å‘å¸ƒå›ºä»¶æ—¶   70+oæ˜¾ç¤ºçš„åç§°
      RELEASE_NAME: ${{ matrix.release_name }}             # å‘å¸ƒå›ºä»¶æ—¶   70+æ˜¾ç¤ºçš„åç§°
    steps:
    - name: å‡†å¤‡çŽ¯å¢ƒ 
      uses: actions/checkout@main
      
    - name: å®‰è£…ç¼–è¯‘çŽ¯å¢ƒ
      run: |     
        version=$(curl -s "https://api.github.com/repos/wxfyes/N1openwrt/releases/latest" | awk -F '"' '/tag_name/{print $4}')
        #  åœ¨è¿™ä¸ªN1å›ºä»¶å‘å¸ƒé“¾æŽ¥ä¸­ï¼Œæ‰¾åˆ°æœ€æ–°çš„"tag_name": "ARMv8_ROOTFS",  å¹¶æŠŠæ ‡ç­¾ç»“æžœ å˜é‡=ARMv8_ROOTFS
        
        
        echo "version=$version"  >> $GITHUB_ENV                            # æŠŠ ARMv8_ROOTFS å˜é‡å†™å…¥     ENVå˜é‡ä¸­
        echo "DATE=$(date "+%Y-%m-%d %H:%M:%S")"  >> $GITHUB_ENV           # æŠŠ DATEæ—¶é—´     å˜é‡å†™å…¥     ENVå˜é‡ä¸­
        
        sudo chmod  -R 777 /opt             # opt 777æƒé™
        cp -r ${FLIPPY_NAME}/opt/* /opt     # æ‹·è´å†…æ ¸è‡³ optç›®å½•å‘¢
                
    - name: ä¸‹è½½
      run: |
        cd /opt/kernel                      # è¿›å…¥ /opt/kernelç›®å½•å†…
        
        wget  https://github.com/wxfyes/N1openwrt/releases/download/$version/openwrt-armvirt-64-default-rootfs.tar.gz                     # è·¯å¾„ä¸­è¡¥å……ç»“æžœå˜é‡ï¼šARMv8_ROOTFSï¼Œç„¶åŽä¸‹è½½
                
    - name: æ£€æŸ¥æ–‡ä»¶
      run: |
        cd /opt/kernel
        ls
                
    - name: å®‰è£…æ‰“åŒ…ä¾èµ–
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install xz-utils btrfs-progs gawk zip unzip curl dosfstools  uuid-runtime
        sudo -E apt-get -qq install git  git-core
        sudo -E apt-get -qq install pigz
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
    
    - name: æ‰“åŒ… img
      run: |
        sudo chmod  -R 777 /opt              # optç›®å½•ç»™æƒé™777
        cd /opt/kernel                       # è¿›å…¥ /opt/kernelç›®å½•å†…
        sudo chmod +x *.sh                   # ç»™ä¸Žå½“å‰ç›®å½•å†… æ‰€æœ‰è„šæœ¬æ‰§è¡Œæƒé™ï¼ï¼
        sudo ./mk_s905d_n1.sh                # æ‰§è¡Œ mk_s905d_n1.sh è„šæœ¬
        
    - name: å¤åˆ¶æ›´æ–°æ–‡ä»¶
      run: |
        cd /opt/kernel
        sudo cp files/update-amlogic-openwrt.sh tmp/update-amlogic-openwrt.sh              # å¤åˆ¶æ›´æ–°è„šæœ¬
        
    - name: pigz -9
      id: pigz
      run: |
        sudo chmod -R 777 /opt/kernel/tmp
        cd /opt/kernel/tmp
        sudo pigz -9 $RELEASE_NAME              # pigz -9æ˜¯åŽ‹ç¼©æ¯”çŽ‡æ¯”è¾ƒå¤§

        echo "::set-output name=status::success"

    - name: æ£€æŸ¥æ–‡ä»¶4
      run: |
        cd /opt/kernel/tmp
        ls

    - name: ç¼–è¯‘åŽç¡¬ç›˜å®¹é‡
      if: (!cancelled())
      run: df -hT

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: release
      uses: ncipollo/release-action@v1
      with:
        name: ${{ env.DATE }} ðŸš€ N1-Openwrt-img | ç¼–è¯‘
        allowUpdates: true                  # æ˜¾ç¤ºæœ€æ–°çš„
        tag: ${{ env.version }}             # å·¦è¾¹æ ‡ç­¾æ˜¾ç¤º versionçš„å˜é‡ ï¼šARMv8_ROOTFS
        commit: master                        # ç­‰äºŽmainåˆ†æ”¯
        token: ${{ secrets.TOKEN }}
        body: |
          ## ä»¥ä¸‹ä¸ºN1çš„æœ€æ–°å›ºä»¶ï¼ˆæ¯æ—¥ä¸Šåˆ7:30å·¦å³è‡ªåŠ¨ç¼–è¯‘æ‰“åŒ…æœ€æ–°å›ºä»¶ï¼‰
          é»˜è®¤IPï¼š192.168.1.254 é»˜è®¤å¯†ç ï¼š password
          æ— çº¿åç§°ï¼šPhicomm_n1 æ— çº¿å¯†ç ï¼špassword
          Openwrt (æ³¨:æ­¤ç‰ˆæœ¬ä¸ºçŽ‹æ™“å³°ä¸ªäººçš„ç²¾ç®€ç‰ˆã€‚+oç‰ˆå†…æ ¸æ›´ç¨³å®š)
          [åšå®¢æŸ¥çœ‹æ›´å¤šå†…å®¹](https://wxf2088.xyz)
          [æŽ¨èvpsæœåŠ¡å™¨â‘ -CN2GIA](https://wxf2088.xyz/2499.html)
          [æŽ¨èvpsæœåŠ¡å™¨â‘¡-CMI](https://wxf2088.xyz/2905.html)
          [æŽ¨èvpsæœåŠ¡å™¨â‘¢-ç¾Žè¥¿](https://wxf2088.xyz/1923.html)
          [é«˜é…ä¾¿å®œvps-æ™®é€šçº¿è·¯](https://tianquege.top/#/register?code=Ybv8Nuvs)
          [ç²¾å“çº¿è·¯æœºåœº](https://tianquege.top/#/register?code=Ybv8Nuvs)
        artifacts: "/opt/kernel/tmp/*"   

    - name: å°†å›ºä»¶ä¸Šä¼ è‡³ WeTransfer
      if: steps.gz.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress /opt/openwrt/tmp/$RELEASE_NAME.gz 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "::set-output name=url::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
        
    - name: åˆ é™¤æ—§ç‰ˆæœ¬
      uses: dev-drprasad/delete-older-releases@v0.1.0
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
